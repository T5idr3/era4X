;SHOP.ERBは完全に各関数を呼び出すエントランス化
;元の処理はSHOP2.ERB及びITEM.ERBに移動
;今後は頻繁にいじる必要が無くなるはず

@EVENTSHOP
DRAWLINE
DRAWLINE

@SHOW_SHOP
#DIM SLG_SHOP_SHOWN

IF SLG_SHOP_SHOWN == 0 && DAY == 1
	SLG_SHOP_SHOWN = 1
	CALL SLG_SHOP
ENDIF
DRAWLINE
PRINTV DAY
PRINT ターン目
IF TIME == 0
	PRINTL (昼)
ELSE
	PRINTL (夜)
ENDIF
IF MONEY == 0
	PRINTFORM (所持金:${MONEY})　難易度:
ELSE
	PRINTFORM (所持金:%TOSTR(MONEY, "$##,###,###,###")%)　難易度:
ENDIF
IF FLAG:4 == 1
	PRINTL EASY
ELSEIF FLAG:4 == 2
	PRINTL NORMAL
ELSEIF FLAG:4 == 3
	PRINTL HARD
ENDIF
SIF TARGET >= CHARANUM
TARGET = -1
IF TARGET >= 0
	PRINTFORML 奴隷:%NAME:TARGET%
	SIF TALENT:恋慕
		PRINT 【恋慕】 
	SIF TALENT:淫乱
		PRINT 【淫乱】 
	SIF TALENT:服従
		PRINT 【服従】 
	SIF TALENT:親愛
		PRINT 【親愛】 
	SIF TALENT:娼婦
		PRINT 【娼婦】 
	SIF TALENT:隷属
		PRINT 【隷属】 
	SIF TALENT:崩壊
		PRINT 【崩壊】 
	PRINTFORML 従順:LV{ABL:0} 欲望:LV{ABL:1} 技巧:LV{ABL:2} 
	CALL LIFE_BAR
	PRINTL 
ENDIF
PRINTFORML 主人:%NAME:MASTER%
SIF ASSI >= 0
	PRINTFORML 助手:%NAME:ASSI%

DRAWLINE
DRAWLINE


;現助手＋元助手のキャラ数の確認
S = 0
T = 0
REPEAT CHARANUM
	;労役中のキャラは排除
	SIF CFLAG:COUNT:12 > 0
		CONTINUE
	;育児部屋に移動しているキャラは除外
	C = COUNT
	SIF CHECK_CHILD_CARE(COUNT) == 1
		CONTINUE
	SIF CFLAG:COUNT:1 == 2
		S += 1
	SIF IS_FALL(COUNT)
		T += 1
REND

;TIMEに合った調教キャラが居るか
E = 0
REPEAT CHARANUM
	;主人と奴隷と労役中のキャラは排除
	SIF COUNT == MASTER
		CONTINUE
	SIF COUNT == TARGET
		CONTINUE
	SIF CFLAG:COUNT:12 > 0
		CONTINUE
	;育児部屋に移動しているキャラは除外
	C = COUNT
	SIF CHECK_CHILD_CARE(COUNT) == 1
		CONTINUE
	E += 1
REND



SIF TARGET >= 0
	PRINTL [100] - 調教
SIF TARGET >= 0 && IS_FALL(TARGET) == 1
	PRINTL [101] - オート調教
SIF TARGET >= 0 && (IS_FALL(TARGET) == 1 || CFLAG:TARGET:1015 == 1)
	PRINTL [105] - 交流
PRINTL [102] - 休憩
PRINTL [103] - アイテム
SIF CHARANUM > 0
	PRINTL [104] - 能力表示
SIF S >= 1
	PRINTL [109] - 助手変更
SIF GET_TRAINABLE_COUNT() >= 1
	PRINTL [110] - 奴隷変更
SIF CHARANUM < 100
	PRINTL [111] - 奴隷購入
SIF T >= 1
	PRINTL [112] - 労働
PRINTL [114] - 奴隷の設定
PRINTL [113] - 宙域管理画面へ
PRINTL [200] - SAVE
PRINTL [300] - LOAD
PRINTL [400] - OPTION
SIF FLAG:2 > 0
	PRINTL [600] - 周回
PRINTL [800] - チュートリアル

@USERSHOP
#DIM CAN_BUY_SLAVE
#DIM CHARA_POS

CAN_BUY_SLAVE = 0
IF BOARDING_SHIP_ID:MASTER != -1
	CHARA_POS = SHIP_POSITION:(BOARDING_SHIP_ID:MASTER)
ELSE
	CHARA_POS = CHARACTER_POSITION
ENDIF
FOR LOCAL, 0, 星系数
	SIF 星系座標ID:LOCAL != CHARA_POS
		CONTINUE
	CAN_BUY_SLAVE = 1
NEXT
FOR LOCAL, 0, MAX_PORT
	SIF PORT_POSITION_ID:LOCAL != CHARA_POS
		CONTINUE
	CAN_BUY_SLAVE = 1
NEXT

IF RESULT == 100 && TARGET >= 0
	BEGIN TRAIN
	RETURN 1
ELSEIF RESULT == 101 && TARGET >= 0 && IS_FALL(TARGET) == 1
	CALL AUTO_TRAIN
	BEGIN ABLUP
	BEGIN TURNEND
	RETURN 1
ELSEIF RESULT == 105 && TARGET >= 0 && (IS_FALL(TARGET) == 1 || CFLAG:TARGET:1015 == 1)
	CALL COMMUNICATION
	SIF RESULT == 0
		RETURN 0
	CALL AFTER_COMMUNICATION
	BEGIN ABLUP
	BEGIN TURNEND
	RETURN 1
ELSEIF RESULT == 102
	;休憩フラグを立てる（ここは特別）
	FLAG:0 = 2
	CALL SLG_TURN_END(0)
	BEGIN TURNEND
	RETURN 1
ELSEIF RESULT == 104 && CHARANUM > 0
	CALL SHOW_CHARADATA
ELSEIF RESULT == 109 && S >= 1
	CALL SELECT_ASSI
ELSEIF RESULT == 110 && GET_TRAINABLE_COUNT() >= 1
	CALL SELECT_TRAINABLE_SALVE
ELSEIF RESULT == 111 && CHARANUM < 100
	IF CAN_BUY_SLAVE == 1
		CALL CHARA_BUY
	ELSE
		PRINTFORMW 宇宙港でないと奴隷は購入できません
	ENDIF
ELSEIF RESULT == 112 && T >= 1
	CALL CHARA_WORKING
ELSEIF RESULT == 114
	CALL SLAVE_SETTING
ELSEIF RESULT == 113
	CALL LEFT_MASTER
	CALL SLG_SHOP
	CALL ARRIVE_MASTER
ELSEIF RESULT == 200
	SAVEGAME
ELSEIF RESULT == 300
	LOADGAME
ELSEIF RESULT == 400
	CALL OPTION
ELSEIF RESULT == 600 && FLAG:2 > 0
	CALL SUCCESSION
ELSEIF RESULT == 800
	CALL TUTORIAL
ENDIF

;アイテム表示の処理
SIF RESULT != 103
	RETURN 0

$ITEM_LOOP
PRINTFORML 所持金:${MONEY}
PRINT_ITEM
CALL SALEITEM_CHECK
CALL PRINT_ITEMMENU
SIF A == -1
	RETURN 0
PRINT_SHOPITEM
CALL BUY_ITEM
GOTO ITEM_LOOP




