;--------------------------
; 漂う巡洋艦
;--------------------------
@INIT_ANOMALY_6
#DIM TASK_COMPLETE
#DIM SECTOR_ID
#DIM POS_X
#DIM POS_Y
; 古代の遺跡
WHILE TASK_COMPLETE == 0
	SECTOR_ID = RAND:MAX_SECTOR
	POS_X = RAND:MAP_WIDTH
	POS_Y = RAND:MAP_HEIGHT
	SIF MAP:SECTOR_ID:POS_X:POS_Y != 明瞭
		CONTINUE
	MAP:SECTOR_ID:POS_X:POS_Y = ANOMALY
	ANOMALY_MAP:SECTOR_ID:POS_X:POS_Y = 古代の遺跡
	CALL POS2ID(SECTOR_ID, POS_X, POS_Y)
	ANOMALY_POSITIONID:6 = RESULT
	TASK_COMPLETE = 1
WEND
ANOMALY_PROGRESS:6 = 1

;--------------------------
; ANOMALY本体
;--------------------------
@ANOMALY_BODY_古代の遺跡
#DIM SECTOR_ID
#DIM X_POS
#DIM Y_POS
#DIM ITER

PRINTFORML 砂漠化した小型惑星が眼下に広がっている
IF SHIP_CATEGORY:BOARDING_SHIP_ID == 調査船
	PRINTFORMW %CALLNAME:MASTER%は早速調査船のセンサーを使って、艦隊と共にめぼしいものを探しながら着陸軌道に乗っかった
	PRINTFORMW ……
	PRINTFORML 辿り着いたのは太古に作られ、朽ち果てた工場のような施設だった
	PRINTFORML しかし入り口には動いている警備ロボットが巡回している
	PRINTFORMW さて、どうするか
	$INPUT_LOOP
	PRINTBUTTON "[0] 探索する", 0
	PRINTL
	PRINTBUTTON "[1] 引き返す", 1
	INPUT
	IF RESULT == 0
		CALL START_ANOMALY_6
	ELSEIF RESULT == 1
		RETURN
	ELSE
		GOTO INPUT_LOOP
	ENDIF
ELSE
	PRINTFORMW しかし調査船でないとめぼしい物がある地域に着地することは不可能だろう……
ENDIF

@START_ANOMALY_6()
#DIM CHARA_LIST, MAX_CHARA_NUM
#DIM OXYGEN
#DIM DYNAMIC CURRENT_POSITION
#DIM IDX
#DIMS _CHARA_DIC, MAX_CHARA_NUM
#DIM SECTOR_ID
#DIM X_POS
#DIM Y_POS

OXYGEN = 20
VARSET _CHARA_DIC, "-1"

PRINTFORMW 酸素量が危険値になれば探索はそこで打ち切りだ。それまでにめぼしいものを見つけなければならない
$INPUT_LOOP
SETCOLOR 0X666666
CUSTOMDRAWLINE ///
RESETCOLOR
PRINTFORML 残り酸素: {OXYGEN}
SETCOLOR 0X666666
CUSTOMDRAWLINE ///
RESETCOLOR

SELECTCASE CURRENT_POSITION
	CASE 0
		PRINTFORML --- 入り口 ---
		IF ANOMALY_PROGRESS:6 == 1
			PRINTFORML 古代の施設の入り口を警備ロボが巡回している
			PRINTFORML 目星を成功させれば密かに進入できそうだ
			CALL SELECT_CHARA_ANOMALY_6_MEBOSHI(CHARA_LIST)
			PRINTFORML 目星: 20以上なら成功
			PRINTW ………………
			PRINTW …………
			PRINTW ……
			LOCAL:1 = RESULT
			LOCAL = RAND(MAX(ABL:RESULT:目星, 1))
			PRINTFORMW 結果: {LOCAL}
			CALL PRINT_ADD_EXP(LOCAL:1, EXPNAME:(GET_EXP(GETNUM(ABL, "目星"))), 5, 1)
			CALL TRAIN_AUTO_ABLUP(LOCAL:1)
			IF 20 <= LOCAL
				PRINTFORML 目星は成功だ！
				PRINTFORML うまく隙をついて古代の施設に侵入することができた
			ELSE
				PRINTFORML 目星は失敗だ……
				PRINTFORML 警備ロボットは%CALLNAME:MASTER%に襲いかかってきた!
				CALL SELECT_CHARA_ANOMALY_6_BATTLE(CHARA_LIST)
				CALL CC_INIT_MEMBER()
				;攻撃側キャラクターの設定(最大6名)
				CALL CC_ADDMOB("ATTACKER", "古代の警備ロボット", 3000, 3000, 50)
				CALL CC_ADDMOB("ATTACKER", "古代の警備ロボット", 3000, 3000, 50)
				;防御側キャラクターの設定(最大6名)
				IDX = 0
				FOR LOCAL, 0, CHARANUM
					IF CHARA_LIST:LOCAL
						CALL CC_ADDCHARA("DEFENDER", LOCAL)
						IF _CHARA_DIC:LOCAL != "-1"
							CC_DEFENDER_LIST:IDX = %_CHARA_DIC:LOCAL%
							IDX ++
						ENDIF
					ENDIF
				NEXT
				;白兵戦イベント呼出
				CALL CLOSE_COMBAT()
				IF RESULT == 1
					PRINTFORMW GAME OVER ...
					INPUT
					CLEARLINE 1
				ENDIF
				CALL CC_ADD_COMBAT_EXP(10)
				FOR LOCAL, 0, FINDELEMENT(CC_DEFENDER_LIST, "-1")
					_CHARA_DIC:(TOINT(DIC_GET(CC_DEFENDER_LIST:LOCAL, "キャラID"))) = %CC_DEFENDER_LIST:LOCAL%
				NEXT
			ENDIF
		ENDIF
		PRINTFORMW %CALLNAME:MASTER%達は先に進んだ
		CURRENT_POSITION++
		OXYGEN --
	CASE 1
		PRINTFORML --- 内部 浅部 ---
		PRINTFORML どうもこの施設は軍事施設だったらしい
		PRINTFORML 朽ちた武器らしきものが所々に転がっている
		$INPUT_LOOP_1
		PRINTBUTTON "[目星する]", 0
		PRINTL
		PRINTBUTTON "[先に進む]", 1
		INPUT
		IF RESULT == 0
			CALL SELECT_CHARA_ANOMALY_6_MEBOSHI(CHARA_LIST)
			PRINTFORML 目星: 20以上なら成功
			PRINTW ………………
			PRINTW …………
			PRINTW ……
			LOCAL:1 = RESULT
			LOCAL = RAND(MAX(ABL:RESULT:目星, 1))
			PRINTFORMW 結果: {LOCAL}
			CALL PRINT_ADD_EXP(LOCAL:1, EXPNAME:(GET_EXP(GETNUM(ABL, "目星"))), 5, 1)
			CALL TRAIN_AUTO_ABLUP(LOCAL:1)
			IF 20 <= LOCAL
				PRINTFORML 目星は成功だ！
				PRINTFORMW 古代のポスターを見つけた。門らしき物から放たれたエネルギーが人々に力を与えているような絵が描かれている
			ELSE
				PRINTFORML 目星は失敗だ……
				PRINTFORMW 何も見つからなかった
			ENDIF
			OXYGEN --
		ELSEIF RESULT != 1
			GOTO INPUT_LOOP_1
		ENDIF
		CURRENT_POSITION ++
		OXYGEN --
	CASE 2
		PRINTFORML --- 内部 研究室 ---
		PRINTFORML 何かしらの研究室らしき部屋に出た
		$INPUT_LOOP_2
		PRINTBUTTON "[目星する]", 0
		PRINTL
		PRINTBUTTON "[先に進む]", 1
		INPUT
		IF RESULT == 0
			CALL SELECT_CHARA_ANOMALY_6_MEBOSHI(CHARA_LIST)
			PRINTFORML 目星: 20以上なら成功
			PRINTW ………………
			PRINTW …………
			PRINTW ……
			LOCAL:1 = RESULT
			LOCAL = RAND(MAX(ABL:RESULT:目星, 1))
			PRINTFORMW 結果: {LOCAL}
			CALL PRINT_ADD_EXP(LOCAL:1, EXPNAME:(GET_EXP(GETNUM(ABL, "目星"))), 5, 1)
			CALL TRAIN_AUTO_ABLUP(LOCAL:1)
			IF 20 <= LOCAL
				PRINTFORML 目星は成功だ！
				PRINTFORML どうやら古代の種族はここで超能力の研究をしていたらしい
				PRINTFORMW しかも古代の種族の資料に描かれているのはどう見ても人間だった
			ELSE
				PRINTFORML 目星は失敗だ……
				PRINTFORMW 何も見つからなかった
			ENDIF
			OXYGEN --
		ELSEIF RESULT != 1
			GOTO INPUT_LOOP_2
		ENDIF
		CURRENT_POSITION ++
		OXYGEN --
	CASE 3
		PRINTFORML --- 内部 司令室 ---
		PRINTFORML 司令室に出た
		IF ANOMALY_PROGRESS:6 == 1
			PRINTFORML 中にいた警備ロボと鉢合わせてしまった
			PRINTFORMW 警備ロボが襲いかかってきた！
			CALL SELECT_CHARA_ANOMALY_6_BATTLE(CHARA_LIST)
			CALL CC_INIT_MEMBER()
			;攻撃側キャラクターの設定(最大6名)
			CALL CC_ADDMOB("ATTACKER", "古代の警備ロボット", 3000, 3000, 50)
			;防御側キャラクターの設定(最大6名)
			IDX = 0
			FOR LOCAL, 0, CHARANUM
				IF CHARA_LIST:LOCAL
					CALL CC_ADDCHARA("DEFENDER", LOCAL)
					SIF _CHARA_DIC:LOCAL != "-1"
						CC_DEFENDER_LIST:IDX = %_CHARA_DIC:LOCAL%
					IDX ++
				ENDIF
			NEXT
			;白兵戦イベント呼出
			CALL CLOSE_COMBAT()
			IF RESULT == 1
				PRINTFORMW GAME OVER ...
				INPUT
				CLEARLINE 1
			ENDIF
			CALL CC_ADD_COMBAT_EXP(5)
			FOR LOCAL, 0, FINDELEMENT(CC_DEFENDER_LIST, "-1")
				_CHARA_DIC:(TOINT(DIC_GET(CC_DEFENDER_LIST:LOCAL, "キャラID"))) = %CC_DEFENDER_LIST:LOCAL%
			NEXT
		ELSE
			PRINTFORMW 中には警備ロボがいたが、襲ってくることはなかった
		ENDIF
		$INPUT_LOOP_3
		PRINTBUTTON "[目星する]", 0
		PRINTL
		PRINTBUTTON "[先に進む]", 1
		INPUT
		IF RESULT == 0
			CALL SELECT_CHARA_ANOMALY_6_MEBOSHI(CHARA_LIST)
			PRINTFORML 目星: 20以上なら成功
			PRINTW ………………
			PRINTW …………
			PRINTW ……
			LOCAL:1 = RESULT
			LOCAL = RAND(MAX(ABL:RESULT:目星, 1))
			PRINTFORMW 結果: {LOCAL}
			CALL PRINT_ADD_EXP(LOCAL:1, EXPNAME:(GET_EXP(GETNUM(ABL, "目星"))), 5, 1)
			CALL TRAIN_AUTO_ABLUP(LOCAL:1)
			IF 20 <= LOCAL
				PRINTFORML 目星は成功だ！
				PRINTFORML 古代のフリゲート艦の操作マニュアルを手に入れた
				ANOMALY_PROGRESS:6 = 3
			ELSE
				PRINTFORML 目星は失敗だ……
				PRINTFORMW 何も見つからなかった
			ENDIF
			OXYGEN --
		ELSEIF RESULT != 1
			GOTO INPUT_LOOP_3
		ENDIF
		CURRENT_POSITION ++
		OXYGEN --
	CASE 4
		PRINTFORML --- 深部 通路 ---
		PRINTFORML 通路に出た
		$INPUT_LOOP_4
		PRINTBUTTON "[目星する]", 0
		PRINTL
		PRINTBUTTON "[先に進む]", 1
		INPUT
		IF RESULT == 0
			CALL SELECT_CHARA_ANOMALY_6_MEBOSHI(CHARA_LIST)
			PRINTFORML 目星: 20以上なら成功
			PRINTW ………………
			PRINTW …………
			PRINTW ……
			LOCAL:1 = RESULT
			LOCAL = RAND(MAX(ABL:RESULT:目星, 1))
			PRINTFORMW 結果: {LOCAL}
			CALL PRINT_ADD_EXP(LOCAL:1, EXPNAME:(GET_EXP(GETNUM(ABL, "目星"))), 5, 1)
			CALL TRAIN_AUTO_ABLUP(LOCAL:1)
			IF 20 <= LOCAL
				PRINTFORML 目星は成功だ！
				PRINTFORML 争ったらしい形跡は存在しない
				PRINTFORMW どうやら自然にここは放棄されたらしい
			ELSE
				PRINTFORML 目星は失敗だ……
				PRINTFORMW 何も見つからなかった
			ENDIF
			OXYGEN --
		ELSEIF RESULT != 1
			GOTO INPUT_LOOP_4
		ENDIF
		CURRENT_POSITION ++
		OXYGEN --
	CASE 5
		PRINTFORML --- 深部 格納庫 ---
		PRINTFORML 艦の格納庫に出た
		PRINTFORML 古代のフリゲートが、非武装状態でずらりと並んでいる
		PRINTFORMW どれも埃を被ってはいるが、今にも動き出しそうだ
		PRINTL
		PRINTFORMW 試しに艦の入り口前に立つと、自動で入り口が開いた
		IF ANOMALY_PROGRESS:6 == 3
			PRINTFORML 操作マニュアルを手に四苦八苦格闘すると、ついに古代のフリゲートの主電源が入った！
			PRINTFORMW さらに格闘すること数十分、発進シークエンスまで持って行けた！
			PRINTL
			PRINTFORML 並んでいた他のフリゲートの電源を入れて周り、追従設定を入れる
			PRINTFORML 発車シークエンスに漕ぎ着けたフリゲートから遠隔でハッチに解放許可を出すが、許可を出す人間がいないのでハッチが開かれることはなかった
			PRINTFORMW 仕方がないので降りてハッチのそばまで行くと、緊急解放用のスイッチを見つけた
			PRINTL
			PRINTFORML 解放スイッチをオンにすると、ハッチが大きな音を立てて軋みながら開いていく
			PRINTFORML %CALLNAME:MASTER%がフリゲートに戻り発進すると、追従して他のフリゲートも発進した
			PRINTFORMW こうして%CALLNAME:MASTER%は古代のフリゲートを6隻手に入れることに成功した！
			
			FOR LOCAL, 0, 6
				CALL INIT_PRESET_SHIP(国家ID_プレイヤー, ANOMALY_POSITIONID:6, 古代のフリゲート, "古代のフリゲート", 古代のフリゲート)
				SHIP_CONDITION:RESULT = 艦船状態_大破
			NEXT
			PRINTFORML しかし装備規格が違うので、相当改修しないと使えないだろう……大破状態の艦並に手を入れなくてはなるまい
			CALL ID2POS(ANOMALY_POSITIONID:6)
			SECTOR_ID = RESULT:0
			X_POS = RESULT:1
			Y_POS = RESULT:2
			ANOMALY_MAP:SECTOR_ID:X_POS:Y_POS = %""%
			MAP:SECTOR_ID:X_POS:Y_POS = 明瞭
			WAIT
			RETURN
		ELSE
			PRINTFORML しかしいくら操作板と格闘しても電源が入らずどうにもならなかった……
			PRINTFORMW 仕方がないので帰還することにした……
			RETURN
		ENDIF
ENDSELECT
IF OXYGEN == 0
	PRINTFORMW 酸素が残り少ない！ 探索チームは撤退を決めた
	RETURN
ENDIF
CALL ASK_YN("続行", "撤退")
SIF RESULT
	RETURN
GOTO INPUT_LOOP
RETURN

@SELECT_CHARA_ANOMALY_6_MEBOSHI(CHARA_LIST)
#DIM REF CHARA_LIST, 0
#DIM _入力値
$INPUT_LOOP
FOR LOCAL, 0, CHARANUM
	SIF CFLAG:LOCAL:所属 != CFLAG:MASTER:所属
		CONTINUE
	SIF CHARACTER_POSITION:LOCAL != CHARACTER_POSITION:MASTER
		CONTINUE
	PRINTBUTTON @"[{LOCAL}] %CALLNAME:LOCAL% 目星: {ABL:LOCAL:目星}", LOCAL
	PRINTL
NEXT
INPUT
_入力値 = RESULT
IF RESULT >= 0 && RESULT < CHARANUM && CFLAG:RESULT:所属 == CFLAG:MASTER:所属 && CHARACTER_POSITION:RESULT == CHARACTER_POSITION:MASTER
	PRINTFORML %CALLNAME:RESULT%に目星させますか？
	CALL ASK_YN
	SIF !RESULT
		RETURN _入力値
ENDIF
GOTO INPUT_LOOP


@SELECT_CHARA_ANOMALY_6_BATTLE(CHARA_LIST)
#DIM REF CHARA_LIST, 0
#DIM _入力値
#DIM CONST _MAX_BATTLE_MEMBER = 6

$INPUT_LOOP
DRAWLINE
PRINTFORML 戦闘メンバー選択
PRINTL
FOR LOCAL, 0, CHARANUM
	SIF CFLAG:LOCAL:所属 != CFLAG:MASTER:所属
		CONTINUE
	SIF CHARACTER_POSITION:LOCAL != CHARACTER_POSITION:MASTER
		CONTINUE
	SIF CHARA_LIST:LOCAL
		SETCOLOR 0X00FF00
	PRINTBUTTON @"[{LOCAL}] %CALLNAME:LOCAL% 白兵: {ABL:LOCAL:白兵} 超能力: {ABL:LOCAL:超能力}", LOCAL
	RESETCOLOR
	PRINTL
NEXT
PRINTBUTTON "[決定]", CHARANUM
INPUT
_入力値 = RESULT
IF RESULT >= 0 && RESULT < CHARANUM && CFLAG:RESULT:所属 == CFLAG:MASTER:所属 && CHARACTER_POSITION:RESULT == CHARACTER_POSITION:MASTER
	CHARA_LIST:RESULT = !CHARA_LIST:RESULT
ELSEIF RESULT == CHARANUM
	IF SUMARRAY(CHARA_LIST) > _MAX_BATTLE_MEMBER || SUMARRAY(CHARA_LIST) < 1
		PRINTFORMW 1~6人までの戦闘メンバーを選んでください
	ELSE
		RETURN
	ENDIF
ENDIF
GOTO INPUT_LOOP



