;--------------------------
; 漂う巡洋艦
;--------------------------
@INIT_ANOMALY_7
#DIM TASK_COMPLETE
#DIM SECTOR_ID
#DIM POS_X
#DIM POS_Y
; 古代の遺跡
WHILE TASK_COMPLETE == 0
	SECTOR_ID = RAND:MAX_SECTOR
	POS_X = RAND:MAP_WIDTH
	POS_Y = RAND:MAP_HEIGHT
	SIF MAP:SECTOR_ID:POS_X:POS_Y != 明瞭
		CONTINUE
	MAP:SECTOR_ID:POS_X:POS_Y = ANOMALY
	ANOMALY_MAP:SECTOR_ID:POS_X:POS_Y = 古代の軍事基地
	CALL POS2ID(SECTOR_ID, POS_X, POS_Y)
	ANOMALY_POSITIONID:7 = RESULT
	TASK_COMPLETE = 1
WEND
ANOMALY_PROGRESS:7 = 1

;--------------------------
; ANOMALY本体
;--------------------------
@ANOMALY_BODY_古代の軍事基地
#DIM SECTOR_ID
#DIM X_POS
#DIM Y_POS
#DIM ITER

PRINTFORML 砂漠化した小型惑星が眼下に広がっている
IF SHIP_CATEGORY:BOARDING_SHIP_ID == 調査船
	PRINTFORMW %CALLNAME:MASTER%は早速調査船のセンサーを使って、艦隊と共にめぼしいものを探しながら着陸軌道に乗っかった
	PRINTFORMW ……
	PRINTFORML 辿り着いたのは太古に作られ、朽ち果てた軍事基地のよう
	PRINTFORML しかし入り口には動いている警備ロボットが大量に巡回している
	PRINTFORMW さて、どうするか
	$INPUT_LOOP
	PRINTBUTTON "[0] 探索する", 0
	PRINTL
	PRINTBUTTON "[1] 引き返す", 1
	INPUT
	IF RESULT == 0
		CALL START_ANOMALY_7
	ELSEIF RESULT == 1
		RETURN
	ELSE
		GOTO INPUT_LOOP
	ENDIF
ELSE
	PRINTFORMW しかし調査船でないとめぼしい物がある地域に着地することは不可能だろう……
ENDIF

@START_ANOMALY_7()
#DIM CHARA_LIST, MAX_CHARA_NUM
#DIM OXYGEN
#DIM DYNAMIC CURRENT_POSITION
#DIM IDX
#DIMS _CHARA_DIC, MAX_CHARA_NUM
#DIM SECTOR_ID
#DIM X_POS
#DIM Y_POS

OXYGEN = 20
VARSET _CHARA_DIC, "-1"

PRINTFORMW 酸素量が危険値になれば探索はそこで打ち切りだ。それまでにめぼしいものを見つけなければならない
$INPUT_LOOP
SETCOLOR 0X666666
CUSTOMDRAWLINE ///
RESETCOLOR
PRINTFORML 残り酸素: {OXYGEN}
SETCOLOR 0X666666
CUSTOMDRAWLINE ///
RESETCOLOR

SELECTCASE CURRENT_POSITION
	CASE 0
		PRINTFORML --- 入り口 ---
		IF ANOMALY_PROGRESS:7 == 1
			PRINTFORML 古代の施設の入り口を警備ロボが巡回している
			PRINTFORML 目星を成功させれば密かに進入できそうだ
			CALL SELECT_CHARA_ANOMALY_7_MEBOSHI(CHARA_LIST)
			PRINTFORML 目星: 60以上なら成功
			PRINTW ………………
			PRINTW …………
			PRINTW ……
			LOCAL:1 = RESULT
			LOCAL = RAND(MAX(ABL:RESULT:目星, 1))
			PRINTFORMW 結果: {LOCAL}
			CALL PRINT_ADD_EXP(LOCAL:1, EXPNAME:(GET_EXP(GETNUM(ABL, "目星"))), 5, 1)
			CALL TRAIN_AUTO_ABLUP(LOCAL:1)
			IF 60 <= LOCAL
				PRINTFORML 目星は成功だ！
				PRINTFORML うまく隙をついて古代の施設に侵入することができた
			ELSE
				PRINTFORML 目星は失敗だ……
				PRINTFORML 警備ロボットは%CALLNAME:MASTER%に襲いかかってきた!
				CALL SELECT_CHARA_ANOMALY_7_BATTLE(CHARA_LIST)
				CALL CC_INIT_MEMBER()
				;攻撃側キャラクターの設定(最大6名)
				CALL CC_ADDMOB("ATTACKER", "古代の警備ロボット1", 5000, 5000, 60)
				CALL CC_ADDMOB("ATTACKER", "古代の警備ロボット2", 5000, 5000, 60)
				CALL CC_ADDMOB("ATTACKER", "古代の警備ロボット3", 5000, 5000, 60)
				CALL CC_ADDMOB("ATTACKER", "古代の警備ロボット4", 5000, 5000, 60)
				CALL CC_ADDMOB("ATTACKER", "古代の警備ロボット5", 5000, 5000, 60)
				CALL CC_ADDMOB("ATTACKER", "古代の警備ロボット6", 5000, 5000, 60)
				;防御側キャラクターの設定(最大6名)
				IDX = 0
				FOR LOCAL, 0, CHARANUM
					IF CHARA_LIST:LOCAL
						CALL CC_ADDCHARA("DEFENDER", LOCAL)
						IF _CHARA_DIC:LOCAL != "-1"
							CC_DEFENDER_LIST:IDX = %_CHARA_DIC:LOCAL%
							IDX ++
						ENDIF
					ENDIF
				NEXT
				;白兵戦イベント呼出
				CALL CLOSE_COMBAT()
				IF RESULT == 1
					PRINTFORMW GAME OVER ...
					INPUT
					CLEARLINE 1
				ENDIF
				CALL CC_ADD_COMBAT_EXP(60)
				FOR LOCAL, 0, FINDELEMENT(CC_DEFENDER_LIST, "-1")
					_CHARA_DIC:(TOINT(DIC_GET(CC_DEFENDER_LIST:LOCAL, "キャラID"))) = %CC_DEFENDER_LIST:LOCAL%
				NEXT
			ENDIF
		ENDIF
		PRINTFORMW %CALLNAME:MASTER%達は先に進んだ
		CURRENT_POSITION++
		OXYGEN --
	CASE 1
		PRINTFORML --- 内部 浅部 ---
		PRINTFORML 古代の基地は清掃ロボットまで生きているのか、中はピカピカに掃除されていた
		$INPUT_LOOP_1
		PRINTBUTTON "[目星する]", 0
		PRINTL
		PRINTBUTTON "[先に進む]", 1
		INPUT
		IF RESULT == 0
			CALL SELECT_CHARA_ANOMALY_7_MEBOSHI(CHARA_LIST)
			PRINTFORML 目星: 50以上なら成功
			PRINTW ………………
			PRINTW …………
			PRINTW ……
			LOCAL:1 = RESULT
			LOCAL = RAND(MAX(ABL:RESULT:目星, 1))
			PRINTFORMW 結果: {LOCAL}
			CALL PRINT_ADD_EXP(LOCAL:1, EXPNAME:(GET_EXP(GETNUM(ABL, "目星"))), 5, 1)
			CALL TRAIN_AUTO_ABLUP(LOCAL:1)
			IF 50 <= LOCAL
				PRINTFORML 目星は成功だ！
				PRINTFORMW 敵の気配を感じた%CALLNAME:MASTER%達は物陰に潜んでやり過ごした
			ELSE
				PRINTFORML 目星は失敗だ……
				PRINTFORML 警備ロボットは%CALLNAME:MASTER%に襲いかかってきた!
				CALL SELECT_CHARA_ANOMALY_7_BATTLE(CHARA_LIST)
				CALL CC_INIT_MEMBER()
				;攻撃側キャラクターの設定(最大6名)
				CALL CC_ADDMOB("ATTACKER", "古代の警備ロボット1", 5000, 5000, 60)
				CALL CC_ADDMOB("ATTACKER", "古代の警備ロボット2", 5000, 5000, 60)
				CALL CC_ADDMOB("ATTACKER", "古代の警備ロボット3", 5000, 5000, 60)
				CALL CC_ADDMOB("ATTACKER", "古代の警備ロボット4", 5000, 5000, 60)
				;防御側キャラクターの設定(最大6名)
				IDX = 0
				FOR LOCAL, 0, CHARANUM
					IF CHARA_LIST:LOCAL
						CALL CC_ADDCHARA("DEFENDER", LOCAL)
						IF _CHARA_DIC:LOCAL != "-1"
							CC_DEFENDER_LIST:IDX = %_CHARA_DIC:LOCAL%
							IDX ++
						ENDIF
					ENDIF
				NEXT
				;白兵戦イベント呼出
				CALL CLOSE_COMBAT()
				IF RESULT == 1
					PRINTFORMW GAME OVER ...
					INPUT
					CLEARLINE 1
				ENDIF
				CALL CC_ADD_COMBAT_EXP(40)
				FOR LOCAL, 0, FINDELEMENT(CC_DEFENDER_LIST, "-1")
					_CHARA_DIC:(TOINT(DIC_GET(CC_DEFENDER_LIST:LOCAL, "キャラID"))) = %CC_DEFENDER_LIST:LOCAL%
				NEXT
			ENDIF
			OXYGEN --
		ELSEIF RESULT != 1
			GOTO INPUT_LOOP_1
		ENDIF
		CURRENT_POSITION ++
		OXYGEN --
	CASE 2
		PRINTFORML --- 内部 研究室 ---
		PRINTFORML 何かしらの研究室らしき部屋に出た
		$INPUT_LOOP_2
		PRINTBUTTON "[目星する]", 0
		PRINTL
		PRINTBUTTON "[先に進む]", 1
		INPUT
		IF RESULT == 0
			CALL SELECT_CHARA_ANOMALY_7_MEBOSHI(CHARA_LIST)
			PRINTFORML 目星: 20以上なら成功
			PRINTW ………………
			PRINTW …………
			PRINTW ……
			LOCAL:1 = RESULT
			LOCAL = RAND(MAX(ABL:RESULT:目星, 1))
			PRINTFORMW 結果: {LOCAL}
			CALL PRINT_ADD_EXP(LOCAL:1, EXPNAME:(GET_EXP(GETNUM(ABL, "目星"))), 5, 1)
			CALL TRAIN_AUTO_ABLUP(LOCAL:1)
			IF 20 <= LOCAL
				PRINTFORML 目星は成功だ！
				PRINTFORML どうやら古代の種族はここで最新の戦艦を開発していたらしい
				PRINTFORMW 設計図が辺りに散らばっている
			ELSE
				PRINTFORML 目星は失敗だ……
				PRINTFORMW 何も見つからなかった
			ENDIF
			OXYGEN --
		ELSEIF RESULT != 1
			GOTO INPUT_LOOP_2
		ENDIF
		CURRENT_POSITION ++
		OXYGEN --
	CASE 3
		PRINTFORML --- 内部 司令室 ---
		PRINTFORML 司令室に出た
		IF ANOMALY_PROGRESS:7 == 1
			PRINTFORML 中にいた警備ロボと鉢合わせてしまった
			PRINTFORMW 警備ロボが襲いかかってきた！
			CALL SELECT_CHARA_ANOMALY_7_BATTLE(CHARA_LIST)
			CALL CC_INIT_MEMBER()
			;攻撃側キャラクターの設定(最大6名)
			CALL CC_ADDMOB("ATTACKER", "古代の警備ロボット1", 3000, 3000, 50)
			CALL CC_ADDMOB("ATTACKER", "古代の警備ロボット2", 3000, 3000, 50)
			CALL CC_ADDMOB("ATTACKER", "古代の警備ロボット3", 3000, 3000, 50)
			CALL CC_ADDMOB("ATTACKER", "古代の警備ロボット4", 3000, 3000, 50)
			CALL CC_ADDMOB("ATTACKER", "古代の警備ロボット5", 3000, 3000, 50)
			CALL CC_ADDMOB("ATTACKER", "古代の警備ロボット6", 3000, 3000, 50)
			;防御側キャラクターの設定(最大6名)
			IDX = 0
			FOR LOCAL, 0, CHARANUM
				IF CHARA_LIST:LOCAL
					CALL CC_ADDCHARA("DEFENDER", LOCAL)
					SIF _CHARA_DIC:LOCAL != "-1"
						CC_DEFENDER_LIST:IDX = %_CHARA_DIC:LOCAL%
					IDX ++
				ENDIF
			NEXT
			;白兵戦イベント呼出
			CALL CLOSE_COMBAT()
			IF RESULT == 1
				PRINTFORMW GAME OVER ...
				INPUT
				CLEARLINE 1
			ENDIF
			CALL CC_ADD_COMBAT_EXP(5)
			FOR LOCAL, 0, FINDELEMENT(CC_DEFENDER_LIST, "-1")
				_CHARA_DIC:(TOINT(DIC_GET(CC_DEFENDER_LIST:LOCAL, "キャラID"))) = %CC_DEFENDER_LIST:LOCAL%
			NEXT
		ELSE
			PRINTFORMW 中には警備ロボがいたが、襲ってくることはなかった
		ENDIF
		$INPUT_LOOP_3
		PRINTBUTTON "[目星する]", 0
		PRINTL
		PRINTBUTTON "[先に進む]", 1
		INPUT
		IF RESULT == 0
			CALL SELECT_CHARA_ANOMALY_7_MEBOSHI(CHARA_LIST)
			PRINTFORML 目星: 50以上なら成功
			PRINTW ………………
			PRINTW …………
			PRINTW ……
			LOCAL:1 = RESULT
			LOCAL = RAND(MAX(ABL:RESULT:目星, 1))
			PRINTFORMW 結果: {LOCAL}
			CALL PRINT_ADD_EXP(LOCAL:1, EXPNAME:(GET_EXP(GETNUM(ABL, "目星"))), 5, 1)
			CALL TRAIN_AUTO_ABLUP(LOCAL:1)
			IF 50 <= LOCAL
				PRINTFORML 目星は成功だ！
				PRINTFORML 古代のタイタンの操作マニュアルを手に入れた
				ANOMALY_PROGRESS:7 = 3
			ELSE
				PRINTFORML 目星は失敗だ……
				PRINTFORMW 何も見つからなかった
			ENDIF
			OXYGEN --
		ELSEIF RESULT != 1
			GOTO INPUT_LOOP_3
		ENDIF
		CURRENT_POSITION ++
		OXYGEN --
	CASE 4
		PRINTFORML --- 深部 通路 ---
		PRINTFORML 通路に出た
		PRINTFORMW 通路では古代の戦車が%CALLNAME:MASTER%達を待ち構えていた！
		CALL SELECT_CHARA_ANOMALY_7_BATTLE(CHARA_LIST)
		CALL CC_INIT_MEMBER()
		;攻撃側キャラクターの設定(最大6名)
		CALL CC_ADDMOB("ATTACKER", "古代の戦車1", 15000, 15000, 140)
		;防御側キャラクターの設定(最大6名)
		IDX = 0
		FOR LOCAL, 0, CHARANUM
			IF CHARA_LIST:LOCAL
				CALL CC_ADDCHARA("DEFENDER", LOCAL)
				IF _CHARA_DIC:LOCAL != "-1"
					CC_DEFENDER_LIST:IDX = %_CHARA_DIC:LOCAL%
					IDX ++
				ENDIF
			ENDIF
		NEXT
		;白兵戦イベント呼出
		CALL CLOSE_COMBAT()
		IF RESULT == 1
			PRINTFORMW GAME OVER ...
			INPUT
			CLEARLINE 1
		ENDIF
		CALL CC_ADD_COMBAT_EXP(40)
		FOR LOCAL, 0, FINDELEMENT(CC_DEFENDER_LIST, "-1")
			_CHARA_DIC:(TOINT(DIC_GET(CC_DEFENDER_LIST:LOCAL, "キャラID"))) = %CC_DEFENDER_LIST:LOCAL%
		NEXT

		$INPUT_LOOP_4
		PRINTBUTTON "[目星する]", 0
		PRINTL
		PRINTBUTTON "[先に進む]", 1
		INPUT
		IF RESULT == 0
			CALL SELECT_CHARA_ANOMALY_7_MEBOSHI(CHARA_LIST)
			PRINTFORML 目星: 20以上なら成功
			PRINTW ………………
			PRINTW …………
			PRINTW ……
			LOCAL:1 = RESULT
			LOCAL = RAND(MAX(ABL:RESULT:目星, 1))
			PRINTFORMW 結果: {LOCAL}
			CALL PRINT_ADD_EXP(LOCAL:1, EXPNAME:(GET_EXP(GETNUM(ABL, "目星"))), 5, 1)
			CALL TRAIN_AUTO_ABLUP(LOCAL:1)
			IF 20 <= LOCAL
				PRINTFORML 目星は成功だ！
				PRINTFORML 先ほどの戦闘の跡以外、争ったらしい形跡は存在しない
				PRINTFORMW どうやら自然にここは放棄されたらしい
			ELSE
				PRINTFORML 目星は失敗だ……
				PRINTFORMW 何も見つからなかった
			ENDIF
			OXYGEN --
		ELSEIF RESULT != 1
			GOTO INPUT_LOOP_4
		ENDIF
		CURRENT_POSITION ++
		OXYGEN --
	CASE 5
		PRINTFORML --- 深部 格納庫 ---
		PRINTFORML 艦の格納庫に出た
		PRINTFORML 恐ろしい異様を誇る古代の超大型戦艦が格納されていた
		PRINTFORMW 人の足で端から端まで歩くのは不可能だろう
		PRINTL
		PRINTFORMW 試しに艦の入り口前に立つと、自動で入り口が開いた
		IF ANOMALY_PROGRESS:7 == 3
			PRINTFORML 操作マニュアルを手に四苦八苦格闘すると、ついに古代のタイタンの主電源が入った！
			PRINTFORMW さらに格闘すること数十分、発進シークエンスまで持って行けた！
			PRINTL
			CALL INIT_PRESET_SHIP(国家ID_プレイヤー, ANOMALY_POSITIONID:7, 古代のタイタン, "古代のタイタン", 古代のタイタン)
			SHIP_CONDITION:RESULT = 艦船状態_大破
			PRINTFORML しかし装備規格が違うので、相当改修しないと使えないだろう……大破状態の艦並に手を入れなくてはなるまい
			CALL ID2POS(ANOMALY_POSITIONID:7)
			SECTOR_ID = RESULT:0
			X_POS = RESULT:1
			Y_POS = RESULT:2
			ANOMALY_MAP:SECTOR_ID:X_POS:Y_POS = %""%
			MAP:SECTOR_ID:X_POS:Y_POS = 明瞭
			WAIT
			RETURN
		ELSE
			PRINTFORML しかしいくら操作板と格闘しても電源が入らずどうにもならなかった……
			PRINTFORMW 仕方がないので帰還することにした……
			RETURN
		ENDIF
ENDSELECT
IF OXYGEN == 0
	PRINTFORMW 酸素が残り少ない！ 探索チームは撤退を決めた
	RETURN
ENDIF
CALL ASK_YN("続行", "撤退")
SIF RESULT
	RETURN
GOTO INPUT_LOOP
RETURN

@SELECT_CHARA_ANOMALY_7_MEBOSHI(CHARA_LIST)
#DIM REF CHARA_LIST, 0
#DIM _入力値
$INPUT_LOOP
FOR LOCAL, 0, CHARANUM
	SIF CFLAG:LOCAL:所属 != CFLAG:MASTER:所属
		CONTINUE
	SIF CHARACTER_POSITION:LOCAL != CHARACTER_POSITION:MASTER
		CONTINUE
	PRINTBUTTON @"[{LOCAL}] %CALLNAME:LOCAL% 目星: {ABL:LOCAL:目星}", LOCAL
	PRINTL
NEXT
INPUT
_入力値 = RESULT
IF RESULT >= 0 && RESULT < CHARANUM && CFLAG:RESULT:所属 == CFLAG:MASTER:所属 && CHARACTER_POSITION:RESULT == CHARACTER_POSITION:MASTER
	PRINTFORML %CALLNAME:RESULT%に目星させますか？
	CALL ASK_YN
	SIF !RESULT
		RETURN _入力値
ENDIF
GOTO INPUT_LOOP


@SELECT_CHARA_ANOMALY_7_BATTLE(CHARA_LIST)
#DIM REF CHARA_LIST, 0
#DIM _入力値
#DIM CONST _MAX_BATTLE_MEMBER = 6

$INPUT_LOOP
DRAWLINE
PRINTFORML 戦闘メンバー選択
PRINTL
FOR LOCAL, 0, CHARANUM
	SIF CFLAG:LOCAL:所属 != CFLAG:MASTER:所属
		CONTINUE
	SIF CHARACTER_POSITION:LOCAL != CHARACTER_POSITION:MASTER
		CONTINUE
	SIF CHARA_LIST:LOCAL
		SETCOLOR 0X00FF00
	PRINTBUTTON @"[{LOCAL}] %CALLNAME:LOCAL% 白兵: {ABL:LOCAL:白兵} 超能力: {ABL:LOCAL:超能力}", LOCAL
	RESETCOLOR
	PRINTL
NEXT
PRINTBUTTON "[決定]", CHARANUM
INPUT
_入力値 = RESULT
IF RESULT >= 0 && RESULT < CHARANUM && CFLAG:RESULT:所属 == CFLAG:MASTER:所属 && CHARACTER_POSITION:RESULT == CHARACTER_POSITION:MASTER
	CHARA_LIST:RESULT = !CHARA_LIST:RESULT
ELSEIF RESULT == CHARANUM
	IF SUMARRAY(CHARA_LIST) > _MAX_BATTLE_MEMBER || SUMARRAY(CHARA_LIST) < 1
		PRINTFORMW 1~6人までの戦闘メンバーを選んでください
	ELSE
		RETURN
	ENDIF
ENDIF
GOTO INPUT_LOOP



