;---------------------------
; 装備更新
;---------------------------

;---------------------------
; 主砲更新
;---------------------------
@EQUIP_UPDATE_0(SHIP_ID, COUNTRY_ID, SLOT_ID)
#DIM SHIP_ID
#DIM COUNTRY_ID
#DIM SLOT_ID
#DIM ITER
#DIM SELECTED
#DIM STATUS, STATUS_LENGTH
#DIM SHIP_STATUS, SHIP_STATUS_LENGTH
IF SHIP_CATEGORY:SHIP_ID == 調査船 || SHIP_CATEGORY:SHIP_ID == 輸送船 || SHIP_CATEGORY:SHIP_ID == 作業船
	PRINTW この艦種は主砲を装備できません
	RETURN
ENDIF
$INPUT_LOOP
IF SHIP_CATEGORY:SHIP_ID != 空母
	PRINTFORML      装備名                               ダメージ  射撃レート 命中率  有効距離  サイズ  費用
	DRAWLINE
	FOR ITER, 0, 99
		TRYCCALLFORM GET_MAIN_WEAPON_STATUS_{ITER}(STATUS)
			TRYCALLFORM GET_SHIP_STATUS_{SHIP_MODEL:SHIP_ID}(SHIP_STATUS)
			SIF SHIP_STATUS:SHIP_MAIN_WEAPON_SIZE < STATUS:SIZE
				CONTINUE
			RESULT = 1
			TRYCALLFORM IS_SALE_MAIN_WEAPON_{ITER}
			SIF RESULT == 0
				CONTINUE
			LOCALS = %TOSTR(STATUS:PRICE, "$####,###")%
			TRYCALLFORM GET_MAIN_WEAPON_NAME_{ITER}
			PRINTBUTTON @"[{ITER, 3, RIGHT}] %RESULTS, 40, LEFT% {STATUS:DAMAGE, 4, RIGHT}\t{STATUS:FIRE_RATE, 2, RIGHT}\t{STATUS:HIT_RATE, 3, RIGHT}\t{STATUS:FIRE_RANGE}\t{STATUS:SIZE}\t%LOCALS%", ITER
			PRINTL
		CATCH
			CONTINUE
		ENDCATCH
	NEXT
	PRINTBUTTON "[戻る]", 999
	INPUT
	SIF RESULT == 999
		RETURN
	SELECTED = RESULT
	TRYCCALLFORM GET_MAIN_WEAPON_STATUS_{SELECTED}(STATUS)
			TRYCALLFORM GET_SHIP_STATUS_{SHIP_MODEL:SHIP_ID}(SHIP_STATUS)
			SIF SHIP_STATUS:SHIP_MAIN_WEAPON_SIZE < STATUS:SIZE
			GOTO INPUT_LOOP
		TRYCALLFORM GET_MAIN_WEAPON_DESCRIPTION_{SELECTED}
		CALL CHECK_BUY
		IF RESULT == 1
			IF STATUS:PRICE > MONEY
				PRINTFORMW 所持金不足です
				GOTO INPUT_LOOP
			ENDIF
			CALL CHANGE_MAIN_WEAPON(SHIP_ID, COUNTRY_ID, SELECTED, SLOT_ID)
			MONEY -= STATUS:PRICE
		ELSE
			GOTO INPUT_LOOP
		ENDIF
	CATCH
		GOTO INPUT_LOOP
	ENDCATCH
ELSE
	PRINTFORML      装備名                            対艦攻撃力 空対空攻撃力  射撃レート  命中率  有効距離  耐久  サイズ  費用
	DRAWLINE
	FOR ITER, 100, 120
		TRYCCALLFORM GET_MAIN_WEAPON_STATUS_{ITER}(STATUS)
			TRYCALLFORM GET_SHIP_STATUS_{SHIP_MODEL:SHIP_ID}(SHIP_STATUS)
			SIF SHIP_STATUS:SHIP_MAIN_WEAPON_SIZE < STATUS:SIZE
				CONTINUE
			RESULT = 1
			TRYCALLFORM IS_SALE_MAIN_WEAPON_{ITER}
			SIF RESULT == 0
				CONTINUE
			LOCALS = %TOSTR(STATUS:PRICE, "$####,###")%
			TRYCALLFORM GET_MAIN_WEAPON_NAME_{ITER}
			PRINTBUTTON @"[{ITER, 3, RIGHT}] %RESULTS, 40, LEFT% {STATUS:DAMAGE, 3, RIGHT}\t{STATUS:ANTI_AIR, 3, RIGHT}\t{STATUS:FIRE_RATE, 3, RIGHT}\t{STATUS:HIT_RATE, 3, RIGHT}\t{STATUS:FIRE_RANGE}\t{AIR_SHIP_HP, 4, RIGHT}\t{STATUS:SIZE}\t%LOCALS%", ITER
			PRINTL
		CATCH
			CONTINUE
		ENDCATCH
	NEXT
	PRINTBUTTON "[戻る]", 999
	INPUT
	SIF RESULT == 999
		RETURN
	SELECTED = RESULT
	TRYCCALLFORM GET_MAIN_WEAPON_STATUS_{SELECTED}(STATUS)
		TRYCALLFORM GET_SHIP_STATUS_{SHIP_MODEL:SHIP_ID}(SHIP_STATUS)
		SIF SHIP_STATUS:SHIP_MAIN_WEAPON_SIZE < STATUS:SIZE
			GOTO INPUT_LOOP
		TRYCALLFORM GET_MAIN_WEAPON_DESCRIPTION_{SELECTED}
		CALL CHECK_BUY
		IF RESULT == 1
			IF STATUS:PRICE > MONEY
				PRINTFORMW 所持金不足です
				GOTO INPUT_LOOP
			ENDIF
			CALL CHANGE_MAIN_WEAPON(SHIP_ID, COUNTRY_ID, SELECTED, SLOT_ID)
			MONEY -= STATUS:PRICE
		ELSE
			GOTO INPUT_LOOP
		ENDIF
	CATCH
		GOTO INPUT_LOOP
	ENDCATCH
ENDIF

;---------------------------
; 副砲更新
;---------------------------
@EQUIP_UPDATE_1(SHIP_ID, COUNTRY_ID, SLOT_ID)
#DIM SHIP_ID
#DIM COUNTRY_ID
#DIM SLOT_ID
#DIM COUNTRY
#DIM ITER
#DIM SELECTED
#DIM STATUS, STATUS_LENGTH
#DIM SHIP_STATUS, SHIP_STATUS_LENGTH
IF SHIP_CATEGORY:SHIP_ID == 調査船 || SHIP_CATEGORY:SHIP_ID == 輸送船 || SHIP_CATEGORY:SHIP_ID == 作業船
	PRINTW この艦種は副砲を装備できません
	RETURN
ENDIF
$INPUT_LOOP
PRINTFORML      装備名                          ダメージ  射撃レート 命中率 対空 有効距離  サイズ  費用
DRAWLINE
FOR ITER, 0, 30
	TRYCCALLFORM GET_SUB_WEAPON_STATUS_{ITER}(STATUS)
		TRYCALLFORM GET_SHIP_STATUS_{SHIP_MODEL:SHIP_ID}(SHIP_STATUS)
		SIF SHIP_STATUS:SHIP_SUB_WEAPON_SIZE < STATUS:SIZE
			CONTINUE
		RESULT = 1
		TRYCALLFORM IS_SALE_SUB_WEAPON_{ITER}
		SIF RESULT == 0
			CONTINUE
		LOCALS = %TOSTR(STATUS:PRICE, "$###,###")%
		TRYCALLFORM GET_SUB_WEAPON_NAME_{ITER}
		PRINTBUTTON @"[{ITER, 3, RIGHT}] %RESULTS, 30, LEFT% {STATUS:DAMAGE, 4, RIGHT}\t{STATUS:FIRE_RATE, 2, RIGHT}\t{STATUS:HIT_RATE, 3, RIGHT}\t{STATUS:ANTI_AIR, 3, RIGHT}\t{STATUS:FIRE_RANGE}\t{STATUS:SIZE}\t%LOCALS%", ITER
		PRINTL
	CATCH
		CONTINUE
	ENDCATCH
NEXT
PRINTBUTTON "[戻る]", 999
INPUT
SIF RESULT == 999
	RETURN
SELECTED = RESULT
TRYCCALLFORM GET_SUB_WEAPON_STATUS_{SELECTED}(STATUS)
	TRYCALLFORM GET_SHIP_STATUS_{SHIP_MODEL:SHIP_ID}(SHIP_STATUS)
	SIF SHIP_STATUS:SHIP_SUB_WEAPON_SIZE < STATUS:SIZE
		GOTO INPUT_LOOP
	TRYCALLFORM GET_SUB_WEAPON_DESCRIPTION_{SELECTED}
	CALL CHECK_BUY
	IF RESULT == 1
		IF STATUS:PRICE > MONEY
			PRINTFORMW 所持金不足です
			GOTO INPUT_LOOP
		ENDIF
		CALL CHANGE_SUB_WEAPON(SHIP_ID, COUNTRY_ID, SELECTED, SLOT_ID)
		MONEY -= STATUS:PRICE
	ELSE
		GOTO INPUT_LOOP
	ENDIF
CATCH
	GOTO INPUT_LOOP
ENDCATCH
;---------------------------
; シールド更新
;---------------------------
@EQUIP_UPDATE_2(SHIP_ID, COUNTRY_ID, SLOT_ID)
#DIM SHIP_ID
#DIM COUNTRY_ID
#DIM SLOT_ID
#DIM ITER
#DIM SELECTED
#DIM STATUS, STATUS_LENGTH
#DIM SHIP_STATUS, SHIP_STATUS_LENGTH
$INPUT_LOOP
PRINTFORML      装備名                               シールド値  シールド自動回復値  サイズ  費用
FOR ITER, 0, 30
	TRYCCALLFORM GET_SIELD_STATUS_{ITER}(STATUS)
		TRYCALLFORM GET_SHIP_STATUS_{SHIP_MODEL:SHIP_ID}(SHIP_STATUS)
		SIF SHIP_STATUS:SHIP_SIELD_SIZE != STATUS:SIZE
			CONTINUE
		RESULT = 1
		TRYCALLFORM IS_SALE_SIELD_{ITER}
		SIF RESULT == 0
			CONTINUE
		LOCALS = %TOSTR(STATUS:PRICE, "$###,###")%
		TRYCALLFORM GET_SIELD_NAME_{ITER}
		PRINTBUTTON @"[{ITER, 3, RIGHT}] %RESULTS, 40, LEFT% {STATUS:SIELD, 4, RIGHT}\t{STATUS:SIELD_RECOVER, 2, RIGHT}\t{STATUS:SIZE}\t%LOCALS%", ITER
		PRINTL
	CATCH
		CONTINUE
	ENDCATCH
NEXT
PRINTBUTTON "[戻る]", 999
INPUT
SIF RESULT == 999
	RETURN
SELECTED = RESULT
TRYCCALLFORM GET_SIELD_STATUS_{SELECTED}(STATUS)
	TRYCALLFORM GET_SHIP_STATUS_{SHIP_MODEL:SHIP_ID}(SHIP_STATUS)
	SIF SHIP_STATUS:SHIP_SIELD_SIZE != STATUS:SIZE
		GOTO INPUT_LOOP
	TRYCALLFORM GET_SIELD_DESCRIPTION_{SELECTED}
	CALL CHECK_BUY
	IF RESULT == 1
		IF STATUS:PRICE > MONEY
			PRINTFORMW 所持金不足です
			GOTO INPUT_LOOP
		ENDIF
		CALL CHANGE_SIELD(SHIP_ID, COUNTRY_ID, SELECTED, SLOT_ID)
		MONEY -= STATUS:PRICE
	ELSE
		GOTO INPUT_LOOP
	ENDIF
CATCH
	GOTO INPUT_LOOP
ENDCATCH
;---------------------------
; 装甲更新
;---------------------------
@EQUIP_UPDATE_3(SHIP_ID, COUNTRY_ID, SLOT_ID)
#DIM SHIP_ID
#DIM COUNTRY_ID
#DIM SLOT_ID
#DIM ITER
#DIM SELECTED
#DIM STATUS, STATUS_LENGTH
#DIM SHIP_STATUS, SHIP_STATUS_LENGTH
$INPUT_LOOP
PRINTFORML      装備名                                  装甲  サイズ  費用
FOR ITER, 0, 30
	TRYCCALLFORM GET_ARMOR_STATUS_{ITER}(STATUS)
		TRYCALLFORM GET_SHIP_STATUS_{SHIP_MODEL:SHIP_ID}(SHIP_STATUS)
		SIF SHIP_STATUS:SHIP_ARMOR_SIZE != STATUS:SIZE
			CONTINUE
		RESULT = 1
		TRYCALLFORM IS_SALE_ARMOR_{ITER}
		SIF RESULT == 0
			CONTINUE
		LOCALS = %TOSTR(STATUS:PRICE, "$###,###")%
		TRYCALLFORM GET_ARMOR_NAME_{ITER}
		PRINTBUTTON @"[{ITER, 3, RIGHT}] %RESULTS, 40, LEFT% {STATUS:ARMOR, 4, RIGHT}\t{STATUS:SIZE}\t%LOCALS%", ITER
		PRINTL
	CATCH
		CONTINUE
	ENDCATCH
NEXT
PRINTBUTTON "[戻る]", 999
INPUT
SIF RESULT == 999
	RETURN
SELECTED = RESULT
TRYCCALLFORM GET_ARMOR_STATUS_{SELECTED}(STATUS)
	TRYCALLFORM GET_SHIP_STATUS_{SHIP_MODEL:SHIP_ID}(SHIP_STATUS)
	SIF SHIP_STATUS:SHIP_ARMOR_SIZE != STATUS:SIZE
		GOTO INPUT_LOOP
	TRYCALLFORM GET_ARMOR_DESCRIPTION_{SELECTED}
	CALL CHECK_BUY
	IF RESULT == 1
		IF STATUS:PRICE > MONEY
			PRINTFORMW 所持金不足です
			GOTO INPUT_LOOP
		ENDIF
		CALL CHANGE_ARMOR(SHIP_ID, COUNTRY_ID, SELECTED, SLOT_ID)
		MONEY -= STATUS:PRICE
	ELSE
		GOTO INPUT_LOOP
	ENDIF
CATCH
	GOTO INPUT_LOOP
ENDCATCH
;---------------------------
; エンジン更新
;---------------------------
@EQUIP_UPDATE_4(SHIP_ID, COUNTRY_ID)
#DIM SHIP_ID
#DIM COUNTRY_ID
#DIM ITER
#DIM SELECTED
#DIM STATUS, STATUS_LENGTH
#DIM SHIP_STATUS, SHIP_STATUS_LENGTH
$INPUT_LOOP
PRINTFORML      装備名                               スピード  回避  サイズ  費用
FOR ITER, 0, 20
	TRYCCALLFORM GET_ENGIN_STATUS_{ITER}(STATUS)
		TRYCALLFORM GET_SHIP_STATUS_{SHIP_MODEL:SHIP_ID}(SHIP_STATUS)
		SIF SHIP_STATUS:SHIP_ENGIN_SIZE != STATUS:SIZE
			CONTINUE
		RESULT = 1
		TRYCALLFORM IS_SALE_ENGIN_{ITER}
		SIF RESULT == 0
			CONTINUE
		LOCALS = %TOSTR(STATUS:PRICE, "$###,###")%
		TRYCALLFORM GET_ENGIN_NAME_{ITER}
		PRINTBUTTON @"[{ITER, 3, RIGHT}] %RESULTS, 40, LEFT% {STATUS:SPEED}\t{STATUS:AVOID, 3, RIGHT}\t{STATUS:SIZE}\t%LOCALS%", ITER
		PRINTL
	CATCH
		CONTINUE
	ENDCATCH
NEXT
PRINTBUTTON "[戻る]", 999
INPUT
SIF RESULT == 999
	RETURN
SELECTED = RESULT
TRYCCALLFORM GET_ENGIN_STATUS_{SELECTED}(STATUS)
	TRYCALLFORM GET_SHIP_STATUS_{SHIP_MODEL:SHIP_ID}(SHIP_STATUS)
	SIF SHIP_STATUS:SHIP_ENGIN_SIZE != STATUS:SIZE
		GOTO INPUT_LOOP
	TRYCALLFORM GET_ENGIN_DESCRIPTION_{SELECTED}
	CALL CHECK_BUY
	IF RESULT == 1
		IF STATUS:PRICE > MONEY
			PRINTFORMW 所持金不足です
			GOTO INPUT_LOOP
		ENDIF
		CALL CHANGE_ENGIN(SHIP_ID, COUNTRY_ID, SELECTED)
		MONEY -= STATUS:PRICE
	ELSE
		GOTO INPUT_LOOP
	ENDIF
CATCH
	GOTO INPUT_LOOP
ENDCATCH
;---------------------------
; AI更新
;---------------------------
@EQUIP_UPDATE_5(SHIP_ID, COUNTRY_ID)
#DIM SHIP_ID
#DIM COUNTRY_ID
#DIM ITER
#DIM SELECTED
#DIM STATUS, STATUS_LENGTH
$INPUT_LOOP
PRINTFORML      %"装備名", 40, LEFT%費用
FOR ITER, 0, 10
	TRYCCALLFORM GET_COMPUTER_STATUS_{ITER}(STATUS)
		RESULT = 1
		TRYCALLFORM IS_SALE_COMPUTER_{ITER}
		SIF RESULT == 0
			CONTINUE
		TRYCALLFORM GET_COMPUTER_NAME_{ITER}
		LOCALS = %TOSTR(STATUS:PRICE, "$###,###")%
		PRINTBUTTON @"[{ITER, 3, RIGHT}] %RESULTS, 40, LEFT%%LOCALS%", ITER
		PRINTL
	CATCH
		CONTINUE
	ENDCATCH
NEXT
PRINTBUTTON "[戻る]", 999
INPUT
SIF RESULT == 999
	RETURN
SELECTED = RESULT
TRYCCALLFORM GET_COMPUTER_DESCRIPTION_{SELECTED}
	CALL CHECK_BUY
	IF RESULT == 1
		TRYCALLFORM GET_COMPUTER_STATUS_{SELECTED}(STATUS)
		IF STATUS:PRICE > MONEY
			PRINTFORMW 所持金不足です
			GOTO INPUT_LOOP
		ENDIF
		CALL CHANGE_COMPUTER(SHIP_ID, COUNTRY_ID, SELECTED)
		MONEY -= STATUS:PRICE
	ELSE
		GOTO INPUT_LOOP
	ENDIF
CATCH
	GOTO INPUT_LOOP
ENDCATCH
;---------------------------
; センサー更新
;---------------------------
@EQUIP_UPDATE_6(SHIP_ID, COUNTRY_ID)
#DIM SHIP_ID
#DIM COUNTRY_ID
#DIM ITER
#DIM SELECTED
#DIM STATUS, STATUS_LENGTH
$INPUT_LOOP
PRINTFORML      装備名                               センサー範囲  費用
FOR ITER, 0, 10
	TRYCCALLFORM GET_SENSOR_STATUS_{ITER}(STATUS)
		RESULT = 1
		TRYCALLFORM IS_SALE_SENSOR_{ITER}
		SIF RESULT == 0
			CONTINUE
		TRYCALLFORM GET_SENSOR_NAME_{ITER}
		LOCALS = %TOSTR(STATUS:PRICE, "$####,###")%
		PRINTBUTTON @"[{ITER, 3, RIGHT}] %RESULTS, 40, LEFT% {STATUS:SENSOR}\t%LOCALS%", ITER
		PRINTL
	CATCH
		CONTINUE
	ENDCATCH
NEXT
PRINTBUTTON "[戻る]", 999
INPUT
SIF RESULT == 999
	RETURN
SELECTED = RESULT
TRYCCALLFORM GET_SENSOR_DESCRIPTION_{SELECTED}
	CALL CHECK_BUY
	IF RESULT == 1
		TRYCALLFORM GET_SENSOR_STATUS_{SELECTED}(STATUS)
		IF STATUS:PRICE > MONEY
			PRINTFORMW 所持金不足です
			GOTO INPUT_LOOP
		ENDIF
		CALL CHANGE_SENSOR(SHIP_ID, COUNTRY_ID, SELECTED)
		MONEY -= STATUS:PRICE
	ELSE
		GOTO INPUT_LOOP
	ENDIF
CATCH
	GOTO INPUT_LOOP
ENDCATCH

;---------------------------
; オプション更新
;---------------------------
@EQUIP_UPDATE_7(SHIP_ID, COUNTRY_ID, SLOT_ID)
#DIM SHIP_ID
#DIM COUNTRY_ID
#DIM SLOT_ID
#DIM ITER
#DIM SELECTED
#DIM STATUS, STATUS_LENGTH
DEBUGPRINTFORM {SLOT_ID}
$INPUT_LOOP
PRINTFORML      %"装備名", 40, LEFT%費用
FOR ITER, 0, 10
	TRYCCALLFORM GET_OPTION_STATUS_{ITER}(STATUS)
		RESULT = 1
		TRYCALLFORM IS_SALE_OPTION_{ITER}
		SIF RESULT == 0
			CONTINUE
		TRYCALLFORM GET_OPTION_NAME_{ITER}
		LOCALS = %TOSTR(STATUS:PRICE, "$####,###")%
		PRINTBUTTON @"[{ITER, 3, RIGHT}] %RESULTS, 40, LEFT%%LOCALS%", ITER
		PRINTL
	CATCH
		CONTINUE
	ENDCATCH
NEXT
PRINTBUTTON "[戻る]", 999
INPUT
SIF RESULT == 999
	RETURN
SELECTED = RESULT
TRYCCALLFORM GET_OPTION_DESCRIPTION_{SELECTED}
	CALL CHECK_BUY
	IF RESULT == 1
		;オプションが装備可能な艦種か見る
		TRYCALLFORM GET_OPTION_CAN_EQUIP_{SELECTED}(SHIP_CATEGORY:SHIP_ID)
		IF  RESULT == 0 
			PRINTFORMW このタイプの艦には装備できません
			GOTO INPUT_LOOP	
		ENDIF
		TRYCALLFORM GET_OPTION_STATUS_{SELECTED}(STATUS)
		IF STATUS:PRICE > MONEY
			PRINTFORMW 所持金不足です
			GOTO INPUT_LOOP
		ENDIF
		;積載量に変更を加えるタイプのオプションは積載中は変更できないようにする
		TRYCALLFORM GET_OPTION_TYPE_{SHIP_EQUIP:オプション:SLOT_ID:SHIP_ID}
		IF  RESULTS == "ADD_CONTAINER"
			CALL SUM_CARGO_SIZE(SHIP_ID)
			IF RESULT > 0
				PRINTFORMW 貨物の搭載中はコンテナ装備の変更は行えません
				GOTO INPUT_LOOP
			ENDIF
		ENDIF
		CALL CHANGE_OPTION(SHIP_ID, COUNTRY_ID, SELECTED, SLOT_ID)
		MONEY -= STATUS:PRICE
	ELSE
		GOTO INPUT_LOOP
	ENDIF
CATCH
	GOTO INPUT_LOOP
ENDCATCH

;---------------------------
; 購入確認
;---------------------------
@CHECK_BUY
DRAWLINE
$INPUT_LOOP
PRINTL 購入しますか？
PRINTBUTTON "[0] 購入", 0
PRINT  
PRINTBUTTON "[1] 戻る", 1
PRINTL
INPUT
IF RESULT == 0
	IF PRICE > MONEY
		SETCOLOR 0XFF0000
		PRINTW 資金不足で買えませんでした
		RESETCOLOR
		RETURN 0
	ENDIF
	RETURN 1
ELSEIF RESULT == 1
	RETURN 0
ELSE
	CLEARLINE 3
	GOTO INPUT_LOOP
ENDIF
