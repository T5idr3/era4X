;--------------------------
; 独立モジュール建造
;--------------------------
; 建設
@CREATE_SPACE_MODULE(_BUILDPOSID)
#DIM _BUILDPOSID
#DIM _COUNTER
#DIM CONST _BUILDINGS = 下級汎用独立モジュール
#DIM CONST _BUILDING_TYPE_COUNT = 1


FOR LOCAL, 0, MAX_SPACE_BUILDING
    SIF SPACE_BUILD_POSITION:LOCAL != -1
        CONTINUE
    PRINTL
    DRAWLINE
    PRINTL 　どの建造物を建造しますか？
    DRAWLINE
    PRINTL
    FOR _COUNTER, 0, _BUILDING_TYPE_COUNT
        TRYCALLFORM GET_SHIP_NAME_{_BUILDINGS}
        PRINT 　
        PRINTBUTTON @"[%RESULTS%]", _COUNTER
        PRINTL
    NEXT
    PRINT 　
    PRINTBUTTON "[キャンセル]", _BUILDING_TYPE_COUNT
    $INPUT_LOOP
    INPUT
    IF RESULT >= 0 && RESULT < _BUILDING_TYPE_COUNT
        SELECTCASE RESULT
            CASE 0
                SPACE_BUILD_BUILDING_TARGET_ID:LOCAL = 下級汎用独立モジュール
        ENDSELECT
    ELSEIF RESULT == _BUILDING_TYPE_COUNT
        RETURN
    ELSE
        CLEARLINE 1
        GOTO INPUT_LOOP
    ENDIF
    FOR LOCAL:1, 0, ITEM_LENGTH
        SPACE_BUILD_RESOURCES:LOCAL:(LOCAL:1) = 0
    NEXT
    SPACE_BUILD_POSITION:LOCAL = _BUILDPOSID
    CALL CONTINUE_SPACE_BUILD(LOCAL)
    BREAK
NEXT

; 建築再開
@CONTINUE_SPACE_BUILD(_ID)
#DIM _ID
#DIM _USE_RESOURCES, ITEM_LENGTH
#DIM _IS_COMPLETE
#DIM _REMOVE_RESOURCE_NUM

VARSET _USE_RESOURCES, 0
CALL GET_SHIP_RESOURCE_145(_USE_RESOURCES)

$INPUT_LOOP

_IS_COMPLETE = 1

PRINTL
DRAWLINE
PRINTL 　現在の進捗
DRAWLINE
PRINTL
FOR LOCAL, 0, ITEM_LENGTH
    CALL GET_ITEM_NAME(LOCAL)
    SIF _USE_RESOURCES:LOCAL == 0
        CONTINUE
    IF _USE_RESOURCES:LOCAL == SPACE_BUILD_RESOURCES:_ID:LOCAL
        SETCOLOR 0X99FF99
    ELSE
        _IS_COMPLETE = 0
    ENDIF
    PRINTFORML 　%RESULTS, 18, LEFT%: {SPACE_BUILD_RESOURCES:_ID:LOCAL, 5, LEFT} / {_USE_RESOURCES:LOCAL, 5, LEFT}
    RESETCOLOR
NEXT
PRINTL
DRAWLINE
PRINT 　
IF _IS_COMPLETE
    PRINTBUTTON "[建造開始]", 0
ELSE
    PRINTBUTTON "[資材の納入]", 1
ENDIF
PRINTL
PRINT 　
PRINTBUTTON "[キャンセル]", 2
PRINTL

INPUT
IF RESULT == 0 && _IS_COMPLETE
    CALL INIT_PRESET_SHIP(国家ID_プレイヤー, SPACE_BUILD_POSITION:_ID, 下級汎用独立モジュール, "下級汎用独立モジュール", 下級汎用独立モジュール)
    SPACE_BUILD_POSITION:_ID = -1
    FOR LOCAL, 0, ITEM_LENGTH
        SPACE_BUILD_RESOURCES:_ID:LOCAL = 0
    NEXT
    SPACE_BUILD_BUILDING_TARGET_ID = -1
    PRINTW ……
    PRINTW …………
    PRINTW ………………
    PRINTW 建造完了しました
    RETURN
ELSEIF RESULT == 1 && _IS_COMPLETE == 0
    FOR LOCAL, 0, ITEM_LENGTH
        SIF _USE_RESOURCES:LOCAL == 0
            CONTINUE
        SIF GET_RESOURCE_NUM(SPACE_BUILD_POSITION:_ID, 国家ID_プレイヤー, LOCAL) == 0
            CONTINUE
        _REMOVE_RESOURCE_NUM = _USE_RESOURCES:LOCAL - SPACE_BUILD_RESOURCES:_ID:LOCAL
        _REMOVE_RESOURCE_NUM -= REMOVE_RESOURCE(SPACE_BUILD_POSITION:_ID, 国家ID_プレイヤー, LOCAL, _REMOVE_RESOURCE_NUM)
        SPACE_BUILD_RESOURCES:_ID:LOCAL += _REMOVE_RESOURCE_NUM
    NEXT
ELSEIF RESULT == 2
    RETURN
ENDIF
GOTO INPUT_LOOP

;-------------------------
; 指定座標で建造物が建造できるか判定する
;-------------------------
@IS_ABLE_BUILD(_POSITION_ID)
#FUNCTION
#DIM _POSITION_ID
#DIM _ENABLE_BUILD

_ENABLE_BUILD = 0

SIF _POSITION_ID != CHARACTER_POSITION:MASTER
    RETURNF 0
FOR LOCAL, 0, MAX_SHIP
    SIF SHIP_COUNTRY:LOCAL != 国家ID_プレイヤー
        CONTINUE
    SIF SHIP_POSITION:LOCAL != _POSITION_ID
        CONTINUE
    SIF SHIP_CATEGORY:LOCAL != 作業船
        CONTINUE
    RETURNF 1
NEXT
RETURNF 0
