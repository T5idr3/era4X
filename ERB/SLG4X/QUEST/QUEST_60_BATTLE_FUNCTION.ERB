;--------------------------
; 戦闘勝敗処理
;--------------------------
@QUEST_ANONYM_BATTLE_RESULT(POS_OPTION)
#DIM SHIP_ID
#DIM SHIP_COUNT
#DIM DESTROYED_COUNT
#DIM POS_ID
#DIM X_POS
#DIM Y_POS
#DIM POS_OPTION

SIF POS_OPTION == 0
	POS_OPTION = CHARACTER_POSITION:MASTER

DESTROYED_COUNT = 0
FOR SHIP_ID, 0, MAX_SHIP
	IF SHIP_POSITION:SHIP_ID != POS_OPTION
		CONTINUE
	ELSEIF SHIP_COUNTRY:SHIP_ID == 国家ID_一般海賊
		CALL GET_SHIP_TOTAL_HP(SHIP_ID)
		IF SHIP_DAMAGE:SHIP_ID >= RESULT
			DESTROYED_COUNT = 99
		ELSE
			SHIP_DAMAGE = RESULT
		ENDIF
	ENDIF
NEXT
CALL RETIRE_BROKEN_SHIP
PRINTFORML 　{POS_OPTION}
PRINTFORMW 　………………。
PRINTFORMW 　…………。
PRINTFORMW 　……。
PRINTFORML 　{DESTROYED_COUNT}
PRINTFORML 

POS_OPTION = 0

RETURN DESTROYED_COUNT
;--------------------------
; 艦を分ける処理
;--------------------------
@QUEST_ANONYM_SPLIT_FLEET(ARGS)
#DIM FIRST_LINE
#DIM NUM
#DIM SHIP_ID
#DIM SELECTED_COUNT
#DIM HP
#DIM MAX_HP
#DIM SP
#DIM MAX_SP

SIF ARGS == ""
	ARGS = "派遣する艦を選択してください。"

CLEARLINE LINECOUNT
DRAWLINE
PRINTL 
PRINTFORML %ARGS%
PRINTL 
SETCOLOR 0X666666
CUSTOMDRAWLINE /
RESETCOLOR
FIRST_LINE = LINECOUNT

$INPUT_LOOP

FOR SHIP_ID, 0, MAX_SHIP
	SIF SHIP_COUNTRY:SHIP_ID != 国家ID_プレイヤー || SHIP_POSITION:SHIP_ID != CHARACTER_POSITION
		CONTINUE
	SIF GROUPMATCH(SHIP_CATEGORY:SHIP_ID, 輸送船, 作業船, 調査船)
		CONTINUE
	SIF ANONYM_FLEET_SELECTED:SHIP_ID
		SELECTED_COUNT ++
NEXT

FOR SHIP_ID, 0, MAX_SHIP
	SIF SHIP_COUNTRY:SHIP_ID != 国家ID_プレイヤー || SHIP_POSITION:SHIP_ID != CHARACTER_POSITION
		CONTINUE
	SIF GROUPMATCH(SHIP_CATEGORY:SHIP_ID, 輸送船, 作業船, 調査船)
		CONTINUE
	
	;;耐久
	CALL GET_SHIP_HP(SHIP_ID)
	HP = RESULT
	CALL GET_SHIP_TOTAL_HP(SHIP_ID)
	MAX_HP = RESULT
	
	IF HP >= MAX_HP
		RESETCOLOR
	ELSEIF HP > MAX_HP / 2
		SETCOLOR カラー_注意
	ELSE
		SETCOLOR カラー_警告
	ENDIF
	
	;;シールド
	CALL GET_SHIP_TOTAL_SIELD(SHIP_ID)
	MAX_SP = RESULT
	CALL GET_SHIP_SIELD(SHIP_ID)
	SP = RESULT

	IF ANONYM_FLEET_SELECTED:SHIP_ID
		SETCOLOR 0X00FF00
		PRINTBUTTON @"[{SHIP_ID,3}] %SHIP_NAME:SHIP_ID,18,LEFT% - 耐久: {HP,5,RIGHT}/{MAX_HP,5,RIGHT} - SHIELD: {SP,5,RIGHT}/{MAX_SP,5,RIGHT}", SHIP_ID
	ELSEIF !ANONYM_FLEET_SELECTED:SHIP_ID
		PRINTBUTTON @"[{SHIP_ID,3}] %SHIP_NAME:SHIP_ID,18,LEFT% - 耐久: {HP,5,RIGHT}/{MAX_HP,5,RIGHT} - SHIELD: {SP,5,RIGHT}/{MAX_SP,5,RIGHT}", SHIP_ID
	ELSE
		PRINTFORML [{SHIP_ID,3}] %SHIP_NAME:SHIP_ID,18,LEFT% - 耐久: {HP,5,RIGHT}/{MAX_HP,5,RIGHT} - SHIELD: {SP,5,RIGHT}/{MAX_SP,5,RIGHT}"
	ENDIF
	RESETCOLOR
	PRINTL 
NEXT

SETCOLOR 0X666666
CUSTOMDRAWLINE /
RESETCOLOR
FINDELEMENT ANONYM_FLEET_SELECTED, 1
IF RESULT == -1
	SETCOLOR カラー_選択不可
	PRINT [9999]決定
	RESETCOLOR
ELSE
	PRINTBUTTON "[9999]決定", 9999
ENDIF
INPUT
IF RESULT >= 0 && RESULT < MAX_SHIP
	IF SHIP_COUNTRY:RESULT == 国家ID_プレイヤー && SHIP_POSITION:RESULT == CHARACTER_POSITION
	IF ANONYM_FLEET_SELECTED:RESULT == 0
		ANONYM_FLEET_SELECTED:RESULT = 1
	ELSE
		ANONYM_FLEET_SELECTED:RESULT = 0
	ENDIF
	ENDIF
ELSEIF RESULT == 9999 && SELECTED_COUNT > 0
	RETURN
ENDIF
CLEARLINE LINECOUNT - FIRST_LINE
GOTO INPUT_LOOP


;--------------------------
; 白兵戦力を抜擢する関数
;--------------------------
@QUEST_ANONYM_SQUAD_CHOICE
#DIM SELECTED_COUNT

VARSET ANONYM_CQC_SELECTED, 0
VARSET PRE_BOARDING_SHIP_ID, -1


$INPUT_LOOP
DRAWLINE
PRINTL 
PRINTL メンバーを選択してください(最大6名)
PRINTL 
SETCOLOR 0X666666
CUSTOMDRAWLINE /
RESETCOLOR
SELECTED_COUNT = 0
FOR LOCAL, 0, CHARANUM
	SIF CFLAG:LOCAL:所属 != CFLAG:MASTER:所属
		CONTINUE
	SIF ANONYM_CQC_SELECTED:LOCAL
		SELECTED_COUNT ++
NEXT
FOR LOCAL, 0, CHARANUM
	SIF CFLAG:LOCAL:所属 != CFLAG:MASTER:所属
		CONTINUE
	IF ANONYM_CQC_SELECTED:LOCAL
		SETCOLOR 0X00FF00
		PRINTBUTTON @"[{LOCAL,2}] %CALLNAME:LOCAL,14,LEFT% - 白兵: {ABL:LOCAL:白兵,3}", LOCAL
		PRINTL
	ELSEIF !ANONYM_CQC_SELECTED:LOCAL && SELECTED_COUNT < 6
		PRINTBUTTON @"[{LOCAL,2}] %CALLNAME:LOCAL,14,LEFT% - 白兵: {ABL:LOCAL:白兵,3}", LOCAL
		PRINTL
	ELSE
		SETCOLOR カラー_選択不可
		PRINTFORML [{LOCAL,2}] %CALLNAME:LOCAL,14,LEFT% - 白兵: {ABL:LOCAL:白兵,3}
	ENDIF
	RESETCOLOR
NEXT
SETCOLOR 0X666666
CUSTOMDRAWLINE /
RESETCOLOR
FINDELEMENT ANONYM_CQC_SELECTED, 1
IF RESULT == -1
	SETCOLOR カラー_選択不可
	PRINT [決定]
	RESETCOLOR
ELSE
	PRINTBUTTON "[決定]", CHARANUM
ENDIF
PRINT 　
PRINTBUTTON "[キャンセル]", CHARANUM + 1
INPUT
IF RESULT == CHARANUM
	FOR LOCAL, 0 ,CHARANUM
		IF ANONYM_CQC_SELECTED:LOCAL
			PRE_BOARDING_SHIP_ID:LOCAL = BOARDING_SHIP_ID:LOCAL
			BOARDING_SHIP_ID:LOCAL = -1
		ENDIF
	NEXT
	RETURN
ELSEIF RESULT == CHARANUM + 1
	FOR LOCAL,0 ,MAX_CHARA_NUM
		ANONYM_CQC_SELECTED:LOCAL = 0
	NEXT
	RETURN
ENDIF
IF RESULT < 0 || RESULT >= CHARANUM || CFLAG:RESULT:所属 != CFLAG:MASTER:所属
	CLEARLINE LINECOUNT
	GOTO INPUT_LOOP
ENDIF
IF ANONYM_CQC_SELECTED:RESULT
	ANONYM_CQC_SELECTED:RESULT = 0
ELSEIF SELECTED_COUNT < 6
	ANONYM_CQC_SELECTED:RESULT = 1
ENDIF
CLEARLINE LINECOUNT
GOTO INPUT_LOOP

;--------------------------
; 艦船に載せ直す（あなたが宙に浮く問題対策応急措置）
;--------------------------
@REBOARDING_SHIP
FOR LOCAL, 0, CHARANUM
	SIF PRE_BOARDING_SHIP_ID:LOCAL != -1
		BOARDING_SHIP_ID:LOCAL = PRE_BOARDING_SHIP_ID:LOCAL
NEXT

;--------------------------
; がめおべら
;--------------------------
@ANONYM_GAME_OVER
$INPUT_LOOP
CLEARLINE LINECOUNT
SETCOLOR カラー_警告
PRINTFORML  　||   ||||   | | || |   || ||  |     |   |  |  |   |||||| ||||| || || ||| ||   ||  |||     |   |   ||    |  
PRINTFORML 
PRINTFORML 
PRINTFORML 
PRINTFORML 
PRINTFORML 
PRINTFORML 
PRINTFORML 
PRINTFORML 
PRINTFORML 
PRINTFORML 　　　　　　　　　　　　　　　　　　　－　　ＧＡＭＥ　ＯＶＥＲ　　－
PRINTFORML 
PRINTFORML 
PRINTFORML 
PRINTFORML 
PRINTFORML 
PRINTFORML 
PRINTFORML 
PRINTFORML 
PRINTFORML 
PRINTFORML 　 || |||||||||| | |||   |  ||    ||||     || ||||| |     | |  | |  ||| || |  | ||  |   |  | |||| |     ||||| 
PRINTFORML 
PRINTFORML 
PRINTFORML 
PRINTFORML 
PRINTFORML 
PRINTFORML 
PRINTFORML 
PRINTFORML 
PRINTFORML 
INPUT
GOTO INPUT_LOOP

