era4X宇宙港スロット技術加算パッチ ver1.00+基地修正
※本体に取り込まれた時点で諸々の権利は放棄するものとします。

----同梱ファイル----

¥ERB¥SLG4X¥PORT.ERB
¥ERB¥SLG4X¥SLG.ERH

----以上2ファイル----



▽説明書きのようなもの
　タイトルの通り、プレイヤーが自前の宇宙港を建設して以降「技術研究所」設置によって可能になる技術研究のうち、
　「宇宙港のスロットが+4される」との記載がある技術の効果が発揮されていなかった（というより未実装だった）点を修正するパッチです。

　該当する技術は
　13:宇宙港中型モジュール開発（TIER2）
　26:宇宙港大型モジュール開発（TIER4）
　33:宇宙港超大型モジュール開発（TIER5）
　の3つですが、上記同梱ファイルの通り、技術研究関連のERBには手を付けていません。



▽おおまかな改変部分について
　SLG.ERH 302行目
　#DIM CONST STAR_PORT_SLOT_NUM = 20
→#DIM CONST STAR_PORT_SLOT_NUM = 32

　PORT.ERB 500行目～590行目付近
→ERB内の当該個所に説明を残しています。




▽改変箇所の概略
　改変・追記個所を見ていただくと分かるように、「技術研究達成によって宇宙港スロットが増える」という説明とは逆に、
　STAR_PORT_SLOT_NUM の初期値を研究分を含めた想定される最大値（ここでは32）にした上で、
　「未達成技術の分だけ扱う宇宙港スロットを減らす」処理になっています。

　これは上記 SLG.ERH において STAR_PORT_SLOT_NUM が303行目以降の複数の配列変数の定義に用いられており、
　PORT.ERB の追記近辺の処理に置いてもその定義された別の配列変数が処理に組み込まれていることにより、
　「達成した技術の分だけ宇宙港スロットを増やす」方向で処理をさせようとすると手を入れる場所がかなり増えてしまうためです。

　実際に、改変した箇所の近辺には

　LOCAL = IS_STAR ? STAR_PORT_SLOT:PORT_ID:SLOT_ID # PORT_SLOT:PORT_ID:SLOT_ID

　といった処理があるのですが、ここで使われている配列変数のうちいくつかは SLG.ERH 内で

　#DIM SAVEDATA STAR_PORT_SLOT, 星系数, STAR_PORT_SLOT_NUM
　#DIM SAVEDATA PORT_SLOT, MAX_PORT, STAR_PORT_SLOT_NUM

　のように定義されており、また STAR_PORT_SLOT_NUM は上記の通り

　#DIM CONST STAR_PORT_SLOT_NUM = 20

　が元々の定義でしたので、この20が上記 STAR_PORT_SLOT や PORT_SLOT の配列変数の範囲としても使われるために、
　「技術の分だけスロットを増やす処理」をやろうとするとエラー（配列変数の第2引数の範囲外）を吐く、というのがありました。
　つまり苦肉の策。

　関数化していないのは、他でこの処理を使い回さなかったことが理由なので、
　可読性とか諸々の点から関数化が望ましいのであれば特に反対はありません。一思いに料理してやってください。

　STAR_PORT_SLOT_NUM については他にも複数個所で使われていますが、
　変更前の設定の20から32にしたことで、白兵訓練所やAVスタジオがあるかどうかの判定での不具合や、
　SLG_INIT.ERB における各国初期設定など、確認できる範囲で検証プレイをした所、特にエラー等は出ませんでしたのでノータッチです。
　（一応、実際にこのパッチをあてた状態で5000期ほど各セクターを飛び回って出来る範囲であれこれしました）



▽ver1.00+での追加
　era4X制作スレ>>330の「宇宙軍基地を一度設置してから別のモジュールで上書きすると再設置できなくなる」バグへの対応。



▽ver1.00+での変更箇所
　PORT.ERB 770行目～780行目付近の、宇宙軍基地モジュール設置を選択した際の重複判定に関して、商店モジュールの処理をコピペ調整。
　また同ERB 1830行目～1860行目付近にもともと存在していた、「惑星の宇宙港に宇宙軍基地モジュールがあるかどうか」の処理関数、
　（前後にある他のモジュール判定と同じものだが、惑星の宇宙港の左メニューで扱う場合のものはもともと記述されていた）
　これに独立宇宙港対応のものをコピペ＆改変で追記、上記770行目付近の処理から呼び出し。



▽更新履歴
  2021/09/03　ver1.00
  2021/09/04  ver1.00+ 宇宙軍基地修正を追加



▽おわりに
　久々のパッチなのでちゃんと動くかどうかちょっと不安ﾈｰ
　宇宙軍基地モジュール関連は突貫作業だったのでチェックが不十分です。


by.宇宙港作業員B